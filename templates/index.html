<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishing Website Detection</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header text-center">
                        <h2 class="mb-3"><i class="fas fa-shield-alt me-2"></i>Phishing Website Detection</h2>
                        <p class="text-light mb-0">Enter a URL to check its authenticity and security status</p>
                    </div>
                    <div class="card-body">
                        <form id="url-form">
                            <div class="input-group mb-4">
                                <span class="input-group-text bg-white border-end-0"><i class="fas fa-link text-muted"></i></span>
                                <input type="url" class="form-control border-start-0" id="url" name="url" 
                                       placeholder="Enter URL (e.g. https://example.com)" required>
                                <button class="btn btn-primary" type="submit" id="submit-btn">
                                    <i class="fas fa-search me-2"></i>Analyze URL
                                </button>
                            </div>
                        </form>

                        <div id="loading" class="text-center d-none">
                            <div class="loading-dots mb-3">
                                <span style="animation-delay: 0s"></span>
                                <span style="animation-delay: 0.2s"></span>
                                <span style="animation-delay: 0.4s"></span>
                            </div>
                            <p class="text-muted">Scanning URL for security threats...</p>
                        </div>

                        <div id="result-box" class="mt-4 d-none">
                            <h4>Analysis Results: <span id="result-url" class="text-break"></span></h4>
                            
                            <div class="alert mt-3 d-flex align-items-center" id="result-alert">
                                <div class="alert-icon me-3">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                                <div>
                                    <h5 class="alert-heading mb-1" id="result-heading"></h5>
                                    <p class="mb-0" id="result-message"></p>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <div class="d-flex justify-content-between mb-2">
                                    <strong>Confidence Score:</strong>
                                    <span class="text-primary fw-bold" id="result-confidence"></span>
                                </div>
                                <div class="confidence-meter">
                                    <div class="confidence-fill"></div>

                                </div>
                                <p id="decision-factors" class="text-muted mt-2 small"></p>
                            </div>
                            
                            <div class="mt-4">
                                <h5><i class="fas fa-microscope me-2"></i>Feature Analysis</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Feature</th>
                                                <th>Value</th>
                                                <th>Interpretation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="feature-table">
                                            <!-- Features will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            $('#url-form').on('submit', function(e) {
                e.preventDefault();
                
                // Show loading
                $('#loading').removeClass('d-none');
                $('#result-box').addClass('d-none');
                $('#submit-btn').prop('disabled', true);
                
                const url = $('#url').val();
                
                $.ajax({
                    url: '/predict',
                    type: 'POST',
                    data: { url: url },
                    success: function(response) {
                        // Hide loading
                        $('#loading').addClass('d-none');
                        $('#submit-btn').prop('disabled', false);
                        
                        if (response.success) {
                            $('#result-box').removeClass('d-none');
                            $('#result-url').text(response.url);
                            
                            let goodFeatures = 0;
                            let suspiciousFeatures = 0;
                            let totalFeatures = 0;
                            let criticalIndicatorsFound = [];
                            
                            const goodWhenZero = ['Have IP Address', 'Have @ Symbol', 'Redirection', 
                                               'HTTPS in Domain', 'TinyURL', 'Prefix/Suffix',
                                               'DNS Record', 'iFrame', 'Mouse Over', 'Right Click', 
                                               'Web Forwards'];
                            const goodWhenOne = ['URL Length', 'Web Traffic', 'Domain Age', 'Domain End'];
                            const criticalIndicators = ['Have IP Address', 'Have @ Symbol', 'TinyURL', 
                                                     'Prefix/Suffix', 'iFrame', 'Right Click'];
                            
                            response.features.forEach(function(feature) {
                                if (feature.name === 'URL Depth') return;
                                
                                totalFeatures++;
                                
                                if (criticalIndicators.includes(feature.name) && feature.value === 1) {
                                    criticalIndicatorsFound.push(feature.name);
                                }
                                
                                if ((goodWhenZero.includes(feature.name) && feature.value === 0) || 
                                    (goodWhenOne.includes(feature.name) && feature.value === 1)) {
                                    goodFeatures++;
                                } else {
                                    suspiciousFeatures++;
                                }
                            });
                            
                            const goodFeaturePercentage = (goodFeatures / totalFeatures) * 100;
                            let finalVerdict = response.is_phishing;
                            let overrideReason = "";
                            
                            if (criticalIndicatorsFound.length > 0) {
                                finalVerdict = true;
                                overrideReason = `Critical phishing indicator(s) found: ${criticalIndicatorsFound.join(', ')}`;
                            }
                            else if (goodFeaturePercentage >= 85) {
                                finalVerdict = false;
                                overrideReason = "High percentage of legitimate features (85%+) and no critical phishing indicators";
                            }
                            else if (goodFeaturePercentage >= 70 && url.startsWith('https://') && criticalIndicatorsFound.length === 0) {
                                finalVerdict = false;
                                overrideReason = "Good percentage of legitimate features (70%+), uses HTTPS, and no critical phishing indicators";
                            }
                            
                            // Update UI elements
                            if (finalVerdict) {
                                $('#result-alert').removeClass('alert-success').addClass('alert-danger');
                                $('#result-heading').text('Potential Phishing Website Detected!');
                                $('#result-message').text('This URL shows characteristics commonly associated with phishing websites.');
                                $('.alert-icon i').removeClass('fa-check-circle').addClass('fa-exclamation-triangle');
                            } else {
                                $('#result-alert').removeClass('alert-danger').addClass('alert-success');
                                $('#result-heading').text('Legitimate Website');
                                $('#result-message').text('This URL appears to be legitimate based on our analysis.');
                                $('.alert-icon i').removeClass('fa-exclamation-triangle').addClass('fa-check-circle');
                            }
                            
                            $('#result-confidence').text(response.confidence);
                            $('.confidence-fill').css('width', response.confidence + '%');
                            
                            if (overrideReason) {
                                $('#decision-factors').text(`Decision factors: ${overrideReason}`);
                            } else {
                                $('#decision-factors').text('Decision based on machine learning model prediction');
                            }
                            
                            if (!finalVerdict) {
                                $('#result-message').append(`<br><br>Feature analysis: ${goodFeatures} out of ${totalFeatures} features indicate a safe website (${goodFeaturePercentage.toFixed(1)}%).`);
                            } else {
                                $('#result-message').append(`<br><br>Feature analysis: ${suspiciousFeatures} out of ${totalFeatures} features indicate a potentially suspicious website (${(100-goodFeaturePercentage).toFixed(1)}%).`);
                            }
                            
                            // Populate feature table
                            const featureTable = $('#feature-table');
                            featureTable.empty();
                            
                            response.features.forEach(function(feature) {
                                let rowClass = '';
                                let valueClass = '';
                                
                                if (criticalIndicators.includes(feature.name) && feature.value === 1) {
                                    rowClass = 'table-danger';
                                    valueClass = 'badge-danger';
                                } else if ((goodWhenZero.includes(feature.name) && feature.value === 0) || 
                                        (goodWhenOne.includes(feature.name) && feature.value === 1)) {
                                    rowClass = 'table-success';
                                    valueClass = 'badge-success';
                                }
                                
                                const featureInterpretation = getFeatureInterpretation(feature.name, feature.value);
                                
                                featureTable.append(`
                                    <tr class="${rowClass}">
                                        <td>
                                            <span class="feature-badge ${valueClass}">${feature.name}</span>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill bg-dark">${feature.value}</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">${featureInterpretation}</small>
                                        </td>
                                    </tr>
                                `);
                            });
                        } else {
                            alert('Error: ' + response.error);
                        }
                    },
                    error: function() {
                        $('#loading').addClass('d-none');
                        $('#submit-btn').prop('disabled', false);
                        alert('Server error occurred. Please try again later.');
                    }
                });
            });
            
            function getFeatureInterpretation(name, value) {
                const interpretations = {
                    'Have IP Address': { '1': 'URL contains IP address (suspicious)', '0': 'URL uses domain name (good)' },
                    'Have @ Symbol': { '1': 'URL contains @ symbol (suspicious)', '0': 'No @ symbol in URL (good)' },
                    'URL Length': { '1': 'Normal URL length (good)', '0': 'Unusually long URL (suspicious)' },
                    'URL Depth': { 'interpretation': `Directory depth: ${value}` },
                    'Redirection': { '1': 'URL contains redirection (suspicious)', '0': 'No redirection in URL (good)' },
                    'HTTPS in Domain': { '1': 'HTTPS is in domain part (suspicious)', '0': 'Proper HTTPS usage (good)' },
                    'TinyURL': { '1': 'Using URL shortening service (suspicious)', '0': 'Not using URL shortening (good)' },
                    'Prefix/Suffix': { '1': 'Contains prefix/suffix separator (suspicious)', '0': 'No prefix/suffix separator (good)' },
                    'DNS Record': { '1': 'No DNS record (suspicious)', '0': 'Valid DNS record exists (good)' },
                    'Web Traffic': { '1': 'High website traffic (good)', '0': 'Low website traffic (suspicious)' },
                    'Domain Age': { '1': 'Domain is older than 6 months (good)', '0': 'Recently created domain (suspicious)' },
                    'Domain End': { '1': 'Domain expiry > 1 year (good)', '0': 'Domain expires soon (suspicious)' },
                    'iFrame': { '1': 'Uses iFrames (suspicious)', '0': 'No iFrames (good)' },
                    'Mouse Over': { '1': 'MouseOver changes status bar (suspicious)', '0': 'No MouseOver scripts (good)' },
                    'Right Click': { '1': 'Right-click disabled (suspicious)', '0': 'Right-click enabled (good)' },
                    'Web Forwards': { '1': 'Forwarding to other domains (suspicious)', '0': 'No forwarding (good)' }
                };
                
                if (name === 'URL Depth') return interpretations[name].interpretation;
                return interpretations[name][value] || 'Unknown';
            }
        });
    </script>
</body>
</html>